<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Playground - Engenharia de Linguagens</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        textarea, input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            margin-bottom: 10px;
            resize: vertical;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button.secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        button.secondary:hover {
            background: #e0e0e0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 10px 15px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #333;
            cursor: pointer;
            font-weight: 600;
        }

        .tab-button.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .result-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .result-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-item {
            margin-bottom: 8px;
            font-family: monospace;
            background: white;
            padding: 10px;
            border-radius: 3px;
            border: 1px solid #eee;
            overflow-x: auto;
        }

        .conflict {
            color: #e74c3c;
            font-weight: 600;
            padding: 10px;
            background: #faddd1;
            border-left: 4px solid #e74c3c;
            border-radius: 3px;
            margin-bottom: 10px;
        }

        .success {
            color: #27ae60;
            font-weight: 600;
            padding: 10px;
            background: #d5f4e6;
            border-left: 4px solid #27ae60;
            border-radius: 3px;
            margin-bottom: 10px;
        }

        .error {
            color: #e74c3c;
            font-weight: 600;
            padding: 10px;
            background: #faddd1;
            border-left: 4px solid #e74c3c;
            border-radius: 3px;
            margin-bottom: 10px;
        }

        .ll1-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .ll1-table th, .ll1-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .ll1-table th {
            background: #f0f0f0;
            font-weight: 600;
        }

        .ll1-table tr:hover {
            background: #f9f9f9;
        }

        .parse-tree {
            font-family: monospace;
            background: white;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-weight: 600;
            margin: 10px 0;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full-width-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .example-button {
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
            height: auto;
            white-space: normal;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }

        .stat-value {
            font-size: 1.8em;
            color: #667eea;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Grammar Playground</h1>
            <p class="subtitle">LL(1) Grammar Analysis & Parse Tree Builder</p>
        </header>

        <!-- Grammar Input and Analysis -->
        <div class="main-grid">
            <!-- Left Panel: Grammar Input -->
            <div class="panel">
                <h2>üìù Defina sua Gram√°tica</h2>
                
                <textarea id="grammarInput" placeholder="Insira sua gram√°tica aqui...
Formato: 
NT ‚Üí Alt1 | Alt2 | Œµ;

Exemplo:
Program ‚Üí StmtList;
Expr ‚Üí Term ExprRest;
..." rows="10">{{ example_grammar }}</textarea>

                <div class="button-group">
                    <button onclick="analyzeGrammar()">Analisar Gram√°tica</button>
                    <button onclick="clearGrammar()" class="secondary">Limpar</button>
                </div>

                <h3>Exemplos R√°pidos</h3>
                <div class="examples-grid" id="examplesGrid">
                    <button class="secondary example-button" onclick="loadExample('pascal_subset')">Pascal Subset</button>
                    <button class="secondary example-button" onclick="loadExample('simple_expr')">Express√µes</button>
                    <button class="secondary example-button" onclick="loadExample('simple_list')">Listas</button>
                </div>
            </div>

            <!-- Right Panel: Analysis Results -->
            <div class="panel">
                <h2>üìä An√°lise LL(1)</h2>
                
                <div id="analysisResults">
                    <p style="text-align: center; color: #999;">Analise uma gram√°tica para ver resultados...</p>
                </div>
            </div>
        </div>

        <!-- Detailed Results Panel -->
        <div class="full-width-panel">
            <h2>üìà Resultados Detalhados</h2>
            
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('first')">FIRST Sets</button>
                <button class="tab-button" onclick="switchTab('follow')">FOLLOW Sets</button>
                <button class="tab-button" onclick="switchTab('table')">LL(1) Tabela</button>
                <button class="tab-button" onclick="switchTab('conflicts')">Conflitos</button>
            </div>

            <div id="first" class="tab-content active">
                <div id="firstContent"></div>
            </div>

            <div id="follow" class="tab-content">
                <div id="followContent"></div>
            </div>

            <div id="table" class="tab-content">
                <div id="tableContent"></div>
            </div>

            <div id="conflicts" class="tab-content">
                <div id="conflictsContent"></div>
            </div>
        </div>

        <!-- Parse Input Panel -->
        <div class="full-width-panel">
            <h2>üîç Analisar Entrada</h2>
            
            <div class="main-grid">
                <div>
                    <label>Insira uma frase para analisar:</label>
                    <textarea id="inputText" placeholder="Exemplo: id := number" rows="5"></textarea>
                    <button onclick="parseInput()">Construir √Årvore de Deriva√ß√£o</button>
                </div>

                <div id="parseResults" style="display: block;">
                    <div id="parseStatus"></div>
                </div>
            </div>

            <div id="parsingResultsSection" style="display: none;">
                <h3>√Årvore de Deriva√ß√£o</h3>
                <div class="tabs">
                    <button class="tab-button active" onclick="switchParseTab('tree')">Visualiza√ß√£o</button>
                    <button class="tab-button" onclick="switchParseTab('text')">Texto</button>
                </div>

                <div id="tree" class="parse-tab-content active">
                    <div id="treeContent" class="parse-tree"></div>
                </div>

                <div id="text" class="parse-tab-content">
                    <div id="textContent" class="parse-tree"></div>
                </div>
            </div>
        </div>

        <!-- Parsing Pipeline Section -->
        <div class="full-width-panel">
            <h2>‚öôÔ∏è Pipeline de An√°lise Completo</h2>
            <p style="color: #666; margin-bottom: 15px;">Insira c√≥digo e veja todos os est√°gios da compila√ß√£o: An√°lise L√©xica ‚Üí Sint√°tica ‚Üí AST ‚Üí Execu√ß√£o</p>
            
            <div class="main-grid">
                <div>
                    <label style="font-weight: 600;">C√≥digo a Analisar:</label>
                    <textarea id="codeInput" placeholder="Insira seu c√≥digo aqui...
Exemplo:
x = 10;
if (x > 5) {
    print(x);
}" rows="10"></textarea>
                    <button onclick="runCompletePipeline()" style="width: 100%;">‚ñ∂ Executar Pipeline Completo</button>
                    <button onclick="runLexical()" class="secondary" style="width: 100%; margin-top: 10px;">1Ô∏è‚É£ An√°lise L√©xica</button>
                    <button onclick="runSyntactic()" class="secondary" style="width: 100%; margin-top: 10px;">2Ô∏è‚É£ An√°lise Sint√°tica</button>
                    <button onclick="runAST()" class="secondary" style="width: 100%; margin-top: 10px;">3Ô∏è‚É£ Construir AST</button>
                    <button onclick="runExecution()" class="secondary" style="width: 100%; margin-top: 10px;">4Ô∏è‚É£ Executar</button>
                </div>

                <div id="pipelineStatus" style="display: block;">
                    <p style="text-align: center; color: #999;">Execute o pipeline para ver os resultados...</p>
                </div>
            </div>

            <!-- Pipeline Results -->
            <div id="pipelineResults" style="display: none; margin-top: 20px;">
                <h3>Resultados do Pipeline</h3>
                
                <div class="tabs">
                    <button class="tab-button active" onclick="switchPipelineTab('lexical')">1. An√°lise L√©xica</button>
                    <button class="tab-button" onclick="switchPipelineTab('syntactic')">2. An√°lise Sint√°tica</button>
                    <button class="tab-button" onclick="switchPipelineTab('ast')">3. AST</button>
                    <button class="tab-button" onclick="switchPipelineTab('execution')">4. Execu√ß√£o</button>
                </div>

                <!-- Stage 1: Lexical -->
                <div id="lexical" class="tab-content active">
                    <div class="result-section">
                        <h3>Tokens (An√°lise L√©xica)</h3>
                        <div id="lexicalContent"></div>
                    </div>
                </div>

                <!-- Stage 2: Syntactic -->
                <div id="syntactic" class="tab-content">
                    <div class="result-section">
                        <h3>√Årvore de An√°lise (An√°lise Sint√°tica)</h3>
                        <div id="syntacticContent" class="parse-tree"></div>
                    </div>
                </div>

                <!-- Stage 3: AST -->
                <div id="ast" class="tab-content">
                    <div class="result-section">
                        <h3>√Årvore de Sintaxe Abstrata</h3>
                        <div id="astContent" class="parse-tree"></div>
                    </div>
                </div>

                <!-- Stage 4: Execution -->
                <div id="execution" class="tab-content">
                    <div class="result-section">
                        <h3>Sa√≠da da Execu√ß√£o</h3>
                        <div id="executionContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentGrammar = null;
        let currentAnalysis = null;

        // Tab switching for analysis results
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tabs').forEach(tabs => {
                tabs.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Tab switching for parse results
        function switchParseTab(tabName) {
            document.querySelectorAll('.parse-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.parse-tab-content').forEach(tab => {
                if (tab.id === tabName) {
                    tab.classList.add('active');
                }
            });
            
            const buttons = event.target.parentElement.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Load example grammar
        async function loadExample(name) {
            try {
                const response = await fetch('/api/examples');
                const examples = await response.json();
                
                if (examples[name]) {
                    document.getElementById('grammarInput').value = examples[name];
                    analyzeGrammar();
                }
            } catch (error) {
                console.error('Error loading example:', error);
            }
        }

        // Clear grammar input
        function clearGrammar() {
            document.getElementById('grammarInput').value = '';
            document.getElementById('analysisResults').innerHTML = 
                '<p style="text-align: center; color: #999;">Analise uma gram√°tica para ver resultados...</p>';
            currentGrammar = null;
            currentAnalysis = null;
        }

        // Analyze grammar
        async function analyzeGrammar() {
            const grammarText = document.getElementById('grammarInput').value;
            
            if (!grammarText.trim()) {
                alert('Por favor, insira uma gram√°tica');
                return;
            }

            try {
                const response = await fetch('/api/analyze-grammar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ grammar: grammarText })
                });

                const data = await response.json();

                if (!data.success) {
                    document.getElementById('analysisResults').innerHTML = 
                        `<div class="error">Erro: ${data.error}</div>`;
                    return;
                }

                currentGrammar = grammarText;
                currentAnalysis = data;

                // Display summary
                displayAnalysisSummary(data);
                
                // Display detailed results
                displayFirstSets(data.first);
                displayFollowSets(data.follow);
                displayLL1Table(data.ll1_table);
                displayConflicts(data.conflicts);

            } catch (error) {
                document.getElementById('analysisResults').innerHTML = 
                    `<div class="error">Erro ao analisar: ${error.message}</div>`;
            }
        }

        // Display analysis summary
        function displayAnalysisSummary(data) {
            let html = '<div class="stats">';
            
            html += `<div class="stat-box">
                        <div class="stat-value">${data.nonterminals.length}</div>
                        <div class="stat-label">N√£o-Terminais</div>
                    </div>`;
            
            html += `<div class="stat-box">
                        <div class="stat-value">${data.terminals.length}</div>
                        <div class="stat-label">Terminais</div>
                    </div>`;
            
            html += `<div class="stat-box">
                        <div class="stat-value">${data.conflict_count}</div>
                        <div class="stat-label">Conflitos</div>
                    </div>`;
            
            html += `<div class="stat-box">
                        <div class="stat-value">${data.is_ll1 ? '‚úì' : '‚úó'}</div>
                        <div class="stat-label">LL(1) V√°lida</div>
                    </div>`;
            
            html += '</div>';

            if (data.conflict_count === 0) {
                html += '<div class="success">‚úì Gram√°tica LL(1) v√°lida! Sem conflitos detectados.</div>';
            } else {
                html += `<div class="conflict">‚ö† ${data.conflict_count} conflito(s) detectado(s)</div>`;
            }

            document.getElementById('analysisResults').innerHTML = html;
        }

        // Display FIRST sets
        function displayFirstSets(firstSets) {
            let html = '<div class="result-section"><h3>FIRST Sets:</h3>';
            
            for (const [nt, symbols] of Object.entries(firstSets)) {
                html += `<div class="result-item"><strong>${nt}:</strong> { ${symbols.join(', ')} }</div>`;
            }
            
            html += '</div>';
            document.getElementById('firstContent').innerHTML = html;
        }

        // Display FOLLOW sets
        function displayFollowSets(followSets) {
            let html = '<div class="result-section"><h3>FOLLOW Sets:</h3>';
            
            for (const [nt, symbols] of Object.entries(followSets)) {
                html += `<div class="result-item"><strong>${nt}:</strong> { ${symbols.join(', ')} }</div>`;
            }
            
            html += '</div>';
            document.getElementById('followContent').innerHTML = html;
        }

        // Display LL(1) table
        function displayLL1Table(table) {
            let html = '<div class="result-section"><h3>LL(1) Parsing Table:</h3>';
            html += '<table class="ll1-table"><tr><th>Non-terminal</th><th>Terminal</th><th>Production</th></tr>';
            
            for (const [key, productions] of Object.entries(table)) {
                const [nt, terminal] = key.split(',');
                html += `<tr>
                    <td>${nt}</td>
                    <td>${terminal}</td>
                    <td>${productions.join(' | ')}</td>
                </tr>`;
            }
            
            html += '</table></div>';
            document.getElementById('tableContent').innerHTML = html;
        }

        // Display conflicts
        function displayConflicts(conflicts) {
            let html = '<div class="result-section"><h3>Conflitos Detectados:</h3>';
            
            if (conflicts.length === 0) {
                html += '<div class="success">Nenhum conflito detectado!</div>';
            } else {
                for (const conflict of conflicts) {
                    html += `<div class="conflict">${conflict}</div>`;
                }
            }
            
            html += '</div>';
            document.getElementById('conflictsContent').innerHTML = html;
        }

        // Parse input
        async function parseInput() {
            if (!currentGrammar) {
                alert('Por favor, analise uma gram√°tica primeiro');
                return;
            }

            const inputText = document.getElementById('inputText').value;
            
            if (!inputText.trim()) {
                alert('Por favor, insira uma frase para analisar');
                return;
            }

            try {
                const response = await fetch('/api/parse-input', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        grammar: currentGrammar,
                        input: inputText 
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    document.getElementById('parseStatus').innerHTML = 
                        `<div class="error">Erro de an√°lise: ${data.error}</div>`;
                    document.getElementById('parsingResultsSection').style.display = 'none';
                    return;
                }

                // Display results
                document.getElementById('treeContent').textContent = data.tree_string;
                document.getElementById('textContent').textContent = data.tree_string;
                
                document.getElementById('parseStatus').innerHTML = 
                    '<div class="success">‚úì An√°lise bem sucedida!</div>';
                document.getElementById('parsingResultsSection').style.display = 'block';

            } catch (error) {
                document.getElementById('parseStatus').innerHTML = 
                    `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        // Utility functions
        function htmlEscape(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load examples on page load
        window.addEventListener('load', () => {
            analyzeGrammar();
        });

        // ========== PARSING PIPELINE FUNCTIONS ==========

        function switchPipelineTab(tabName) {
            document.querySelectorAll('#pipelineResults .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#pipelineResults .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function runLexical() {
            const code = document.getElementById('codeInput').value;
            
            if (!code.trim()) {
                alert('Por favor, insira c√≥digo');
                return;
            }

            try {
                const response = await fetch('/api/lexical-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const data = await response.json();

                if (data.success) {
                    displayLexicalResults(data);
                } else {
                    document.getElementById('lexicalContent').innerHTML = 
                        `<div class="error">Erro: ${data.error}</div>`;
                }

                document.getElementById('pipelineResults').style.display = 'block';
                switchPipelineTab('lexical');

            } catch (error) {
                document.getElementById('lexicalContent').innerHTML = 
                    `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        async function runSyntactic() {
            const code = document.getElementById('codeInput').value;
            
            if (!code.trim()) {
                alert('Por favor, insira c√≥digo');
                return;
            }

            try {
                const response = await fetch('/api/syntactic-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('syntacticContent').textContent = data.parse_tree_string;
                    document.getElementById('pipelineResults').style.display = 'block';
                    switchPipelineTab('syntactic');
                } else {
                    document.getElementById('syntacticContent').innerHTML = 
                        `<div class="error">Erro: ${data.error}</div>`;
                }

            } catch (error) {
                document.getElementById('syntacticContent').innerHTML = 
                    `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        async function runAST() {
            const code = document.getElementById('codeInput').value;
            
            if (!code.trim()) {
                alert('Por favor, insira c√≥digo');
                return;
            }

            try {
                const response = await fetch('/api/build-ast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const data = await response.json();

                if (data.success) {
                    let html = `<div class="result-item"><strong>AST Estrutura:</strong></div>`;
                    html += `<div class="result-item">${escapeHtml(JSON.stringify(data.ast, null, 2))}</div>`;
                    
                    if (data.errors && data.errors.length > 0) {
                        html += `<div class="conflict">Avisos: ${data.errors.join(', ')}</div>`;
                    }
                    
                    document.getElementById('astContent').innerHTML = html;
                    document.getElementById('pipelineResults').style.display = 'block';
                    switchPipelineTab('ast');
                } else {
                    document.getElementById('astContent').innerHTML = 
                        `<div class="error">Erro: ${data.error}</div>`;
                }

            } catch (error) {
                document.getElementById('astContent').innerHTML = 
                    `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        async function runExecution() {
            const code = document.getElementById('codeInput').value;
            
            if (!code.trim()) {
                alert('Por favor, insira c√≥digo');
                return;
            }

            try {
                const response = await fetch('/api/execute-parser', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const data = await response.json();

                let html = '';

                if (data.output && data.output.length > 0) {
                    html += '<div class="success">‚úì Execu√ß√£o bem-sucedida!</div>';
                    html += '<div class="result-section"><h4>Sa√≠da:</h4>';
                    for (const out of data.output) {
                        html += `<div class="result-item">${escapeHtml(out)}</div>`;
                    }
                    html += '</div>';
                } else if (data.success) {
                    html += '<div class="success">‚úì Execu√ß√£o bem-sucedida (sem output)</div>';
                } else {
                    html += '<div class="conflict">‚úó Execu√ß√£o com erros</div>';
                }

                if (data.errors && data.errors.length > 0) {
                    html += '<div class="result-section"><h4>Erros:</h4>';
                    for (const err of data.errors) {
                        html += `<div class="result-item error-text">${escapeHtml(err)}</div>`;
                    }
                    html += '</div>';
                }

                if (data.result) {
                    html += `<div class="result-section"><h4>Resultado:</h4><div class="result-item">${escapeHtml(data.result)}</div></div>`;
                }

                document.getElementById('executionContent').innerHTML = html;
                document.getElementById('pipelineResults').style.display = 'block';
                switchPipelineTab('execution');

            } catch (error) {
                document.getElementById('executionContent').innerHTML = 
                    `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        async function runCompletePipeline() {
            const code = document.getElementById('codeInput').value;
            
            if (!code.trim()) {
                alert('Por favor, insira c√≥digo');
                return;
            }

            document.getElementById('pipelineStatus').innerHTML = '<div style="color: #667eea; font-weight: 600;">‚è≥ Executando pipeline...</div>';
            document.getElementById('pipelineResults').style.display = 'none';

            try {
                const response = await fetch('/api/complete-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const data = await response.json();
                const analysis = data.analysis;

                // Display lexical results
                if (analysis.lexical && analysis.lexical.success) {
                    displayLexicalResults(analysis.lexical);
                }

                // Display syntactic results
                if (analysis.syntactic && analysis.syntactic.success) {
                    document.getElementById('syntacticContent').textContent = analysis.syntactic.parse_tree_string;
                }

                // Display AST results
                if (analysis.ast && analysis.ast.success) {
                    let astHtml = `<div class="result-item"><strong>AST Construction Successful</strong></div>`;
                    if (analysis.ast.errors && analysis.ast.errors.length > 0) {
                        astHtml += `<div class="conflict">Warnings: ${analysis.ast.errors.join(', ')}</div>`;
                    }
                    document.getElementById('astContent').innerHTML = astHtml;
                }

                // Display execution results
                if (analysis.execution) {
                    let execHtml = '';
                    
                    if (analysis.execution.success) {
                        execHtml += '<div class="success">‚úì Execution Successful</div>';
                    } else {
                        execHtml += '<div class="conflict">‚úó Execution Failed</div>';
                    }

                    if (analysis.execution.output && analysis.execution.output.length > 0) {
                        execHtml += '<div class="result-section"><h4>Output:</h4>';
                        for (const out of analysis.execution.output) {
                            execHtml += `<div class="result-item">${escapeHtml(out)}</div>`;
                        }
                        execHtml += '</div>';
                    }

                    if (analysis.execution.errors && analysis.execution.errors.length > 0) {
                        execHtml += '<div class="result-section"><h4>Errors:</h4>';
                        for (const err of analysis.execution.errors) {
                            execHtml += `<div class="conflict">${escapeHtml(err)}</div>`;
                        }
                        execHtml += '</div>';
                    }

                    document.getElementById('executionContent').innerHTML = execHtml;
                }

                // Display status
                let statusHtml = `<div class="stats">`;
                statusHtml += `<div class="stat-box"><div class="stat-value">${analysis.stages_completed}</div><div class="stat-label">Est√°gios Conclu√≠dos</div></div>`;
                statusHtml += `</div>`;

                if (analysis.stages_completed === 4) {
                    statusHtml += '<div class="success">‚úì Pipeline completado com sucesso!</div>';
                } else {
                    statusHtml += `<div class="conflict">‚ö† Pipeline parcialmente conclu√≠do (${analysis.stages_completed}/4)</div>`;
                }

                document.getElementById('pipelineStatus').innerHTML = statusHtml;
                document.getElementById('pipelineResults').style.display = 'block';
                switchPipelineTab('lexical');

            } catch (error) {
                document.getElementById('pipelineStatus').innerHTML = 
                    `<div class="error">Erro: ${error.message}</div>`;
            }
        }

        function displayLexicalResults(data) {
            let html = `<div class="result-section">`;
            html += `<p>Total de tokens: <strong>${data.token_count}</strong></p>`;
            html += `<table class="ll1-table"><tr><th>Token</th><th>Tipo</th><th>Posi√ß√£o</th></tr>`;

            for (const token of data.tokens) {
                if (token.type !== 'EOF') {
                    html += `<tr><td>${escapeHtml(token.value)}</td><td>${token.type}</td><td>${token.line}:${token.column}</td></tr>`;
                }
            }

            html += `</table></div>`;
            document.getElementById('lexicalContent').innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
                    <tr>
                        <td class="border p-2 font-bold bg-gray-50">{{ nt }}</td>
                        {% for t in res.terminais %}
                            <td class="border p-2 text-sm">
                                {{ res.tabela.get(nt ~ ',' ~ t, '-') }}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</body>
</html>